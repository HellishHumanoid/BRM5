--[[
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    BRM5 ESP SYSTEM v2.2.2 - ENHANCED FOV VISIBILITY (MORE SENSITIVE)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    GAME CHARACTER STRUCTURE:
    â€¢ All in-game characters are R15 rigs
    â€¢ HumanoidRootPart is called "Root" (NOT "HumanoidRootPart")
    â€¢ All player characters are named "Male"
    â€¢ Players have a "Humanoid" instance
    â€¢ NPCs (non-players) are also named "Male" but WITHOUT "Humanoid"
    â€¢ Zombies are named "Zombie" and have a "Humanoid"
    
    CHANGELOG v2.2.2:
    â€¢ ENHANCED FOV detection - now checks 8 body parts instead of 3
    â€¢ Added raycasts for: LeftUpperArm, RightUpperArm, LeftUpperLeg, RightUpperLeg, LeftLowerLeg
    â€¢ ESP now shows if ANY body part is visible (arms, legs, head, torso)
    â€¢ More sensitive detection - catches partial visibility
    â€¢ Still maintains all v2.2.1 freeze fixes
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
]]

-- PART 1: Core Configuration, Base Functions and Visibility System

-- Load Rayfield Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local UserInputService = game:GetService("UserInputService")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Control Variables
local espMaleEnabled = false
local espNPCEnabled = false
local espZombieEnabled = false
local espFOVOnlyEnabled = false
local visibilityCheckEnabled = false
local fullbrightEnabled = false
local espMaleObjects = {}
local espNPCObjects = {}
local espZombieObjects = {}
local partVisibility = {}
local fullbrightLoop

-- ESP Configuration
local ESP_MALE_COLOR = Color3.fromRGB(255, 255, 255)
local ESP_NPC_COLOR = Color3.fromRGB(255, 165, 0)
local ESP_ZOMBIE_COLOR = Color3.fromRGB(255, 0, 0)
local USE_HIGHLIGHT = true

-- Visibility Colors (Gradient: Red -> Orange -> Yellow -> Green)
local COLOR_HIDDEN = Color3.fromRGB(255, 0, 0)
local COLOR_LOW = Color3.fromRGB(255, 140, 0)
local COLOR_MEDIUM = Color3.fromRGB(255, 200, 0)
local COLOR_VISIBLE = Color3.fromRGB(0, 255, 0)

-- OPTIMIZED refresh rate (30ms = ~33 FPS update rate)
local VISIBILITY_CHECK_INTERVAL = 0.03

-- ðŸ”¥ FREEZE FIX: Reuse RaycastParams instead of creating new ones
local rayParamsCache = RaycastParams.new()
rayParamsCache.FilterType = Enum.RaycastFilterType.Exclude
rayParamsCache.IgnoreWater = true

-- Convert HEX to Color3
local function hexToColor3(hex)
    hex = hex:gsub("#", "")
    if #hex ~= 6 then return nil end
    
    local r = tonumber(hex:sub(1, 2), 16)
    local g = tonumber(hex:sub(3, 4), 16)
    local b = tonumber(hex:sub(5, 6), 16)
    
    if r and g and b then
        return Color3.fromRGB(r, g, b)
    end
    return nil
end

-- ðŸ”§ NEW: Verify if model is actually a character (not furniture)
local function isValidCharacter(model)
    if not model or not model:IsA("Model") then return false end
    
    -- Must have Root part
    local root = model:FindFirstChild("Root")
    if not root or not root:IsA("BasePart") then return false end
    
    -- Must have Head (all R15 characters have Head)
    local head = model:FindFirstChild("Head")
    if not head or not head:IsA("BasePart") then return false end
    
    -- Must have UpperTorso (R15 specific)
    local upperTorso = model:FindFirstChild("UpperTorso")
    if not upperTorso or not upperTorso:IsA("BasePart") then return false end
    
    -- Must have LowerTorso (R15 specific)
    local lowerTorso = model:FindFirstChild("LowerTorso")
    if not lowerTorso or not lowerTorso:IsA("BasePart") then return false end
    
    return true
end

-- ðŸ†• ENHANCED: Now checks 8 body parts for maximum visibility detection
local function isInCameraFOVAndVisible(character)
    if not character or not character:FindFirstChild("Root") then return false end
    
    -- ðŸ”§ NEW: Verify it's actually a character
    if not isValidCharacter(character) then return false end
    
    local root = character:FindFirstChild("Root")
    if not root then return false end
    
    local camCFrame = Camera.CFrame
    local rootPos = root.Position
    local camPos = camCFrame.Position
    
    -- Distance check - skip if too far
    local distance = (rootPos - camPos).Magnitude
    if distance > 1000 then return false end
    
    -- Get vector from camera to character
    local toCharacter = (rootPos - camPos).Unit
    local cameraLookVector = camCFrame.LookVector
    
    -- Calculate dot product (cosine of angle)
    local dotProduct = toCharacter:Dot(cameraLookVector)
    
    -- FOV check: Must be in front of camera
    if dotProduct < 0.1 then
        return false -- Not in FOV
    end
    
    -- ðŸ†• ENHANCED: Check multiple body parts for better detection
    local partsToCheck = {
        -- Critical parts (high priority)
        "Head",
        "UpperTorso",
        "LowerTorso",
        -- Arms (medium priority)
        "LeftUpperArm",
        "RightUpperArm",
        "LeftLowerArm",
        "RightLowerArm",
        -- Legs (lower priority but still important)
        "LeftUpperLeg",
        "RightUpperLeg",
        "LeftLowerLeg",
        "RightLowerLeg"
    }
    
    -- ðŸ”¥ FREEZE FIX: REUSE rayParamsCache
    local ignoreList = rayParamsCache.FilterDescendantsInstances or {}
    table.clear(ignoreList) -- Clear instead of creating new
    
    if LocalPlayer.Character then
        table.insert(ignoreList, LocalPlayer.Character)
    end
    table.insert(ignoreList, character)
    rayParamsCache.FilterDescendantsInstances = ignoreList
    
    -- ðŸ†• Check all body parts - if ANY is visible, show ESP
    for _, partName in ipairs(partsToCheck) do
        local part = character:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            local direction = part.Position - camPos
            local result = workspace:Raycast(camPos, direction, rayParamsCache)
            
            -- If raycast didn't hit anything, this part is visible
            if not result then
                return true -- Found a visible part!
            end
        end
    end
    
    -- Also check root as absolute last resort
    local direction = rootPos - camPos
    local result = workspace:Raycast(camPos, direction, rayParamsCache)
    return not result
end

-- ðŸ”¥ FREEZE FIX: Optimized - Reuses raycast params
local function checkPartVisibility(part)
    if not part or not part:IsA("BasePart") then return 0 end
    
    local camPos = Camera.CFrame.Position
    local partPos = part.Position
    
    -- Only 2 test points for maximum performance
    local testPoints = {
        partPos,
        partPos + Vector3.new(0, part.Size.Y/4, 0)
    }
    
    -- ðŸ”¥ FREEZE FIX: REUSE rayParamsCache instead of creating new RaycastParams
    local ignoreList = rayParamsCache.FilterDescendantsInstances or {}
    table.clear(ignoreList) -- Clear instead of creating new table
    
    if LocalPlayer.Character then
        table.insert(ignoreList, LocalPlayer.Character)
    end
    if part.Parent then
        table.insert(ignoreList, part.Parent)
    end
    rayParamsCache.FilterDescendantsInstances = ignoreList
    
    local visibleCount = 0
    for _, testPos in ipairs(testPoints) do
        local direction = (testPos - camPos)
        local result = workspace:Raycast(camPos, direction, rayParamsCache)
        
        if not result then
            visibleCount = visibleCount + 1
        end
    end
    
    return visibleCount / 2 -- Always 2 test points
end

local function getCharacterVisibility(character)
    if not character then return 0 end
    
    -- Most important parts first (optimization)
    local criticalParts = {"Head", "UpperTorso", "LowerTorso"}
    local armParts = {"LeftUpperArm", "RightUpperArm"}
    
    local totalVisibility = 0
    local visiblePartCount = 0
    local criticalVisible = 0
    local criticalCount = 0
    
    if not partVisibility[character] then
        partVisibility[character] = {}
    end
    
    -- Check critical parts first (head and torso)
    for _, partName in ipairs(criticalParts) do
        local part = character:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            local visibility = checkPartVisibility(part)
            partVisibility[character][part] = visibility
            
            if visibility > 0 then
                criticalVisible = criticalVisible + visibility
                criticalCount = criticalCount + 1
                totalVisibility = totalVisibility + visibility
                visiblePartCount = visiblePartCount + 1
            end
        end
    end
    
    -- Check arms (less weight)
    for _, partName in ipairs(armParts) do
        local part = character:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            local visibility = checkPartVisibility(part)
            partVisibility[character][part] = visibility
            
            if visibility > 0 then
                totalVisibility = totalVisibility + (visibility * 0.5)
                visiblePartCount = visiblePartCount + 0.5
            end
        end
    end
    
    if visiblePartCount == 0 then
        return 0
    end
    
    -- Calculate total visibility
    local finalVisibility = totalVisibility / math.max(criticalCount + 1, 1)
    
    -- If only arms visible, limit to 0.35
    if criticalCount == 0 and visiblePartCount > 0 then
        return math.min(finalVisibility, 0.35)
    end
    
    return math.clamp(finalVisibility, 0, 1)
end

local function getColorFromVisibility(visibility)
    if visibility <= 0.2 then
        local t = visibility / 0.2
        return COLOR_HIDDEN:Lerp(COLOR_LOW, t)
    elseif visibility < 0.5 then
        local t = (visibility - 0.2) / 0.3
        return COLOR_LOW:Lerp(COLOR_MEDIUM, t)
    else
        local t = (visibility - 0.5) / 0.5
        return COLOR_MEDIUM:Lerp(COLOR_VISIBLE, t)
    end
end

-- ðŸ”¥ FREEZE FIX: Clean up dead characters from partVisibility
local function cleanupPartVisibility()
    for character, _ in pairs(partVisibility) do
        if not character or not character.Parent then
            partVisibility[character] = nil
        end
    end
end

-- OPTIMIZED: Instant ESP visibility updates
local function updateMaleESPColors()
    for character, espObject in pairs(espMaleObjects) do
        if character and character.Parent and espObject and espObject.Parent then
            local success = pcall(function()
                -- FOV Mode: Instant visibility toggle
                if espFOVOnlyEnabled then
                    local inFOVAndVisible = isInCameraFOVAndVisible(character)
                    espObject.Enabled = inFOVAndVisible
                    
                    -- Force white color in FOV mode
                    if inFOVAndVisible then
                        if espObject:IsA("Highlight") then
                            espObject.FillColor = Color3.fromRGB(255, 255, 255)
                        elseif espObject:IsA("Folder") then
                            for _, adornment in pairs(espObject:GetChildren()) do
                                if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                    adornment.Color3 = Color3.fromRGB(255, 255, 255)
                                end
                            end
                        end
                    end
                    return
                end
                
                -- Normal mode: Always visible
                espObject.Enabled = true
                
                -- Apply visibility check colors if enabled
                if visibilityCheckEnabled then
                    local overallVisibility = getCharacterVisibility(character)
                    local color = getColorFromVisibility(overallVisibility)
                    
                    if espObject:IsA("Highlight") then
                        espObject.FillColor = color
                    elseif espObject:IsA("Folder") then
                        for _, adornment in pairs(espObject:GetChildren()) do
                            if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                local part = adornment.Adornee
                                if part and partVisibility[character] and partVisibility[character][part] then
                                    local partVis = partVisibility[character][part]
                                    adornment.Color3 = getColorFromVisibility(partVis)
                                end
                            end
                        end
                    end
                else
                    if espObject:IsA("Highlight") then
                        espObject.FillColor = ESP_MALE_COLOR
                    elseif espObject:IsA("Folder") then
                        for _, adornment in pairs(espObject:GetChildren()) do
                            if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                adornment.Color3 = ESP_MALE_COLOR
                            end
                        end
                    end
                end
            end)
            if not success then
                espMaleObjects[character] = nil
            end
        end
    end
end

local function updateNPCESPColors()
    for character, espObject in pairs(espNPCObjects) do
        if character and character.Parent and espObject and espObject.Parent then
            local success = pcall(function()
                -- FOV Mode: Show only in FOV, force orange color
                if espFOVOnlyEnabled then
                    local inFOVAndVisible = isInCameraFOVAndVisible(character)
                    espObject.Enabled = inFOVAndVisible
                    
                    -- Force NPC color in FOV mode (orange by default)
                    if inFOVAndVisible then
                        if espObject:IsA("Highlight") then
                            espObject.FillColor = ESP_NPC_COLOR
                        elseif espObject:IsA("Folder") then
                            for _, adornment in pairs(espObject:GetChildren()) do
                                if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                    adornment.Color3 = ESP_NPC_COLOR
                                end
                            end
                        end
                    end
                    return -- Exit early in FOV mode
                end
                
                -- Normal mode: Always visible
                espObject.Enabled = true
                
                -- Apply visibility check colors if enabled
                if visibilityCheckEnabled then
                    local overallVisibility = getCharacterVisibility(character)
                    local color = getColorFromVisibility(overallVisibility)
                    
                    if espObject:IsA("Highlight") then
                        espObject.FillColor = color
                    elseif espObject:IsA("Folder") then
                        for _, adornment in pairs(espObject:GetChildren()) do
                            if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                local part = adornment.Adornee
                                if part and partVisibility[character] and partVisibility[character][part] then
                                    local partVis = partVisibility[character][part]
                                    adornment.Color3 = getColorFromVisibility(partVis)
                                end
                            end
                        end
                    end
                else
                    -- Normal mode with custom NPC color
                    if espObject:IsA("Highlight") then
                        espObject.FillColor = ESP_NPC_COLOR
                    elseif espObject:IsA("Folder") then
                        for _, adornment in pairs(espObject:GetChildren()) do
                            if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                adornment.Color3 = ESP_NPC_COLOR
                            end
                        end
                    end
                end
            end)
            if not success then
                espNPCObjects[character] = nil
            end
        end
    end
end

local function updateZombieESPColors()
    for character, espObject in pairs(espZombieObjects) do
        if character and character.Parent and espObject and espObject.Parent then
            local success = pcall(function()
                -- FOV Mode: Show only in FOV, force red color
                if espFOVOnlyEnabled then
                    local inFOVAndVisible = isInCameraFOVAndVisible(character)
                    espObject.Enabled = inFOVAndVisible
                    
                    -- Force Zombie color in FOV mode (red by default)
                    if inFOVAndVisible then
                        if espObject:IsA("Highlight") then
                            espObject.FillColor = ESP_ZOMBIE_COLOR
                        elseif espObject:IsA("Folder") then
                            for _, adornment in pairs(espObject:GetChildren()) do
                                if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                    adornment.Color3 = ESP_ZOMBIE_COLOR
                                end
                            end
                        end
                    end
                    return -- Exit early in FOV mode
                end
                
                -- Normal mode: Always visible
                espObject.Enabled = true
                
                -- Apply visibility check colors if enabled
                if visibilityCheckEnabled then
                    local overallVisibility = getCharacterVisibility(character)
                    local color = getColorFromVisibility(overallVisibility)
                    
                    if espObject:IsA("Highlight") then
                        espObject.FillColor = color
                    elseif espObject:IsA("Folder") then
                        for _, adornment in pairs(espObject:GetChildren()) do
                            if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                local part = adornment.Adornee
                                if part and partVisibility[character] and partVisibility[character][part] then
                                    local partVis = partVisibility[character][part]
                                    adornment.Color3 = getColorFromVisibility(partVis)
                                end
                            end
                        end
                    end
                else
                    -- Normal mode with custom Zombie color
                    if espObject:IsA("Highlight") then
                        espObject.FillColor = ESP_ZOMBIE_COLOR
                    elseif espObject:IsA("Folder") then
                        for _, adornment in pairs(espObject:GetChildren()) do
                            if adornment:IsA("BoxHandleAdornment") and adornment.Name == "ESPBox" then
                                adornment.Color3 = ESP_ZOMBIE_COLOR
                            end
                        end
                    end
                end
            end)
            if not success then
                espZombieObjects[character] = nil
            end
        end
    end
end

-- Fullbright functions
local function brightFunc()
    pcall(function()
        Lighting.Brightness = 2
        Lighting.ClockTime = 14
        Lighting.FogEnd = 100000
        Lighting.GlobalShadows = false
        Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
    end)
end

-- ðŸ”¥ FREEZE FIX: Optimized fullbright (only updates when needed)
local function enableFullbright()
    if fullbrightLoop then fullbrightLoop:Disconnect() end
    brightFunc()
    
    -- Use Heartbeat instead of RenderStepped (runs less often)
    fullbrightLoop = RunService.Heartbeat:Connect(function()
        -- Only update if values changed (prevents unnecessary updates)
        if Lighting.Brightness ~= 2 or Lighting.ClockTime ~= 14 then
            brightFunc()
        end
    end)
end

local function disableFullbright()
    if fullbrightLoop then
        fullbrightLoop:Disconnect()
        fullbrightLoop = nil
    end
    pcall(function()
        Lighting.Brightness = 1
        Lighting.ClockTime = 12
        Lighting.FogEnd = 100000
        Lighting.GlobalShadows = true
        Lighting.OutdoorAmbient = Color3.fromRGB(70, 70, 70)
    end)
end

-- ESP creation functions
local function createESPHighlight(character, color)
    local success, result = pcall(function()
        local h = Instance.new("Highlight")
        h.Name = "ESPHighlight"
        h.Adornee = character
        h.FillColor = color
        h.OutlineColor = Color3.fromRGB(255, 255, 255)
        h.FillTransparency = 0.5
        h.OutlineTransparency = 0
        h.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
        h.Parent = character
        return h
    end)
    return success and result or nil
end

local function createESPBox(character, color)
    local espFolder = Instance.new("Folder")
    espFolder.Name = "ESPFolder"
    espFolder.Parent = character
    
    local mainParts = {"Head", "UpperTorso", "LowerTorso", "LeftUpperArm", "RightUpperArm"}
    
    for _, partName in pairs(mainParts) do
        local part = character:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            pcall(function()
                local box = Instance.new("BoxHandleAdornment")
                box.Name = "ESPBox"
                box.Size = part.Size
                box.Adornee = part
                box.Color3 = color
                box.Transparency = 0.5
                box.AlwaysOnTop = true
                box.ZIndex = 10
                box.Parent = espFolder
                
                local outline = Instance.new("BoxHandleAdornment")
                outline.Name = "ESPOutline"
                outline.Size = part.Size + Vector3.new(0.05, 0.05, 0.05)
                outline.Adornee = part
                outline.Color3 = Color3.fromRGB(255, 255, 255)
                outline.Transparency = 0.8
                outline.AlwaysOnTop = true
                outline.ZIndex = 9
                outline.Parent = espFolder
            end)
        end
    end
    return espFolder
end

-- CONTINUE TO PART 2...
-- PART 2: ESP Functions and Character Management (FREEZE FIX APPLIED)

-- PLAYER ESP FUNCTIONS
local function createMaleESP(character)
    if not character or espMaleObjects[character] then return end
    
    -- ðŸ”§ NEW: Verify it's actually a character (not furniture)
    if not isValidCharacter(character) then return end
    
    local root = character:FindFirstChild("Root")
    if not root then return end
    
    if not character:FindFirstChild("Humanoid") then return end
    
    local espObject = createESPHighlight(character, ESP_MALE_COLOR)
    if not espObject then
        espObject = createESPBox(character, ESP_MALE_COLOR)
        USE_HIGHLIGHT = false
    end
    
    if espObject then
        espMaleObjects[character] = espObject
    end
end

-- ðŸ”¥ FREEZE FIX: Clean partVisibility when removing ESP
local function removeMaleESP(character)
    if espMaleObjects[character] then
        pcall(function() espMaleObjects[character]:Destroy() end)
        espMaleObjects[character] = nil
    end
    if partVisibility[character] then
        partVisibility[character] = nil
    end
    -- Extra cleanup
    pcall(function()
        local esp = character:FindFirstChild("ESPHighlight")
        if esp then esp:Destroy() end
        local folder = character:FindFirstChild("ESPFolder")
        if folder then folder:Destroy() end
    end)
end

local function updateMaleESP()
    if espMaleEnabled then
        for _, model in pairs(workspace:GetChildren()) do
            if model.Name == "Male" and model:FindFirstChild("Root") and model:FindFirstChild("Humanoid") then
                -- ðŸ”§ NEW: Verify it's actually a character
                if isValidCharacter(model) and not espMaleObjects[model] then
                    createMaleESP(model)
                end
            end
        end
    else
        -- IMPROVED: Better cleanup
        for character, espObject in pairs(espMaleObjects) do
            pcall(function() 
                if espObject and espObject.Parent then
                    espObject:Destroy() 
                end
            end)
            if partVisibility[character] then
                partVisibility[character] = nil
            end
        end
        espMaleObjects = {}
        
        -- Extra pass to clean any remaining ESP
        for _, model in pairs(workspace:GetChildren()) do
            if model.Name == "Male" and model:FindFirstChild("Humanoid") then
                pcall(function()
                    local esp = model:FindFirstChild("ESPHighlight")
                    if esp then esp:Destroy() end
                    local folder = model:FindFirstChild("ESPFolder")
                    if folder then folder:Destroy() end
                end)
            end
        end
    end
end

-- NPC ESP FUNCTIONS (FIXED CLEANUP)
local function createNPCESP(character)
    if not character or espNPCObjects[character] then return end
    
    -- ðŸ”§ NEW: Verify it's actually a character (not furniture)
    if not isValidCharacter(character) then return end
    
    local root = character:FindFirstChild("Root")
    if not root then return end
    
    if character:FindFirstChild("Humanoid") then return end
    
    local espObject = createESPHighlight(character, ESP_NPC_COLOR)
    if not espObject then
        espObject = createESPBox(character, ESP_NPC_COLOR)
    end
    
    if espObject then
        espNPCObjects[character] = espObject
    end
end

-- ðŸ”¥ FREEZE FIX: Clean partVisibility when removing ESP
local function removeNPCESP(character)
    if espNPCObjects[character] then
        pcall(function() 
            if espNPCObjects[character].Parent then
                espNPCObjects[character]:Destroy() 
            end
        end)
        espNPCObjects[character] = nil
    end
    if partVisibility[character] then
        partVisibility[character] = nil
    end
    -- Extra cleanup
    pcall(function()
        local esp = character:FindFirstChild("ESPHighlight")
        if esp then esp:Destroy() end
        local folder = character:FindFirstChild("ESPFolder")
        if folder then folder:Destroy() end
    end)
end

local function updateNPCESP()
    if espNPCEnabled then
        for _, model in pairs(workspace:GetChildren()) do
            if model.Name == "Male" and model:FindFirstChild("Root") and not model:FindFirstChild("Humanoid") then
                -- ðŸ”§ NEW: Verify it's actually a character
                if isValidCharacter(model) and not espNPCObjects[model] then
                    createNPCESP(model)
                end
            end
        end
    else
        -- FIXED: Aggressive cleanup for NPCs
        print("Cleaning NPC ESP...") -- Debug message
        
        -- First pass: Destroy tracked objects
        for character, espObject in pairs(espNPCObjects) do
            pcall(function() 
                if espObject and espObject.Parent then
                    espObject:Destroy()
                    print("Destroyed ESP for:", character.Name)
                end
            end)
            if partVisibility[character] then
                partVisibility[character] = nil
            end
        end
        
        -- Clear the table
        espNPCObjects = {}
        
        -- Second pass: Manual cleanup of any remaining ESP on NPCs
        for _, model in pairs(workspace:GetChildren()) do
            if model.Name == "Male" and not model:FindFirstChild("Humanoid") then
                pcall(function()
                    local esp = model:FindFirstChild("ESPHighlight")
                    if esp then 
                        esp:Destroy()
                        print("Manual cleanup ESP on:", model.Name)
                    end
                    local folder = model:FindFirstChild("ESPFolder")
                    if folder then 
                        folder:Destroy()
                        print("Manual cleanup Folder on:", model.Name)
                    end
                end)
            end
        end
        
        -- Third pass: Search all descendants for stray ESP objects
        for _, desc in pairs(workspace:GetDescendants()) do
            pcall(function()
                if desc:IsA("Highlight") and desc.Name == "ESPHighlight" then
                    if desc.Parent and desc.Parent.Name == "Male" and not desc.Parent:FindFirstChild("Humanoid") then
                        desc:Destroy()
                        print("Deep cleanup Highlight")
                    end
                end
                if desc:IsA("Folder") and desc.Name == "ESPFolder" then
                    if desc.Parent and desc.Parent.Name == "Male" and not desc.Parent:FindFirstChild("Humanoid") then
                        desc:Destroy()
                        print("Deep cleanup Folder")
                    end
                end
            end)
        end
        
        print("NPC ESP cleanup complete!")
    end
end

-- ZOMBIE ESP FUNCTIONS
local function createZombieESP(character)
    if not character or espZombieObjects[character] then return end
    
    -- ðŸ”§ NEW: Verify it's actually a character (not furniture)
    if not isValidCharacter(character) then return end
    
    local root = character:FindFirstChild("Root")
    if not root then return end
    
    if not character:FindFirstChild("Humanoid") then return end
    
    local espObject = createESPHighlight(character, ESP_ZOMBIE_COLOR)
    if not espObject then
        espObject = createESPBox(character, ESP_ZOMBIE_COLOR)
    end
    
    if espObject then
        espZombieObjects[character] = espObject
    end
end

-- ðŸ”¥ FREEZE FIX: Clean partVisibility when removing ESP
local function removeZombieESP(character)
    if espZombieObjects[character] then
        pcall(function() espZombieObjects[character]:Destroy() end)
        espZombieObjects[character] = nil
    end
    if partVisibility[character] then
        partVisibility[character] = nil
    end
    -- Extra cleanup
    pcall(function()
        local esp = character:FindFirstChild("ESPHighlight")
        if esp then esp:Destroy() end
        local folder = character:FindFirstChild("ESPFolder")
        if folder then folder:Destroy() end
    end)
end

local function updateZombieESP()
    if espZombieEnabled then
        for _, model in pairs(workspace:GetChildren()) do
            if model.Name == "Zombie" and model:FindFirstChild("Root") and model:FindFirstChild("Humanoid") then
                -- ðŸ”§ NEW: Verify it's actually a character
                if isValidCharacter(model) and not espZombieObjects[model] then
                    createZombieESP(model)
                end
            end
        end
    else
        -- IMPROVED: Better cleanup
        for character, espObject in pairs(espZombieObjects) do
            pcall(function() 
                if espObject and espObject.Parent then
                    espObject:Destroy() 
                end
            end)
            if partVisibility[character] then
                partVisibility[character] = nil
            end
        end
        espZombieObjects = {}
        
        -- Extra pass
        for _, model in pairs(workspace:GetChildren()) do
            if model.Name == "Zombie" then
                pcall(function()
                    local esp = model:FindFirstChild("ESPHighlight")
                    if esp then esp:Destroy() end
                    local folder = model:FindFirstChild("ESPFolder")
                    if folder then folder:Destroy() end
                end)
            end
        end
    end
end

-- Workspace listeners
workspace.ChildAdded:Connect(function(child)
    task.wait(0.1)
    if child.Name == "Male" then
        if not child:FindFirstChild("Root") then return end
        
        -- ðŸ”§ NEW: Verify it's actually a character
        if not isValidCharacter(child) then return end
        
        if espMaleEnabled and child:FindFirstChild("Humanoid") then
            createMaleESP(child)
        elseif espNPCEnabled and not child:FindFirstChild("Humanoid") then
            createNPCESP(child)
        end
    elseif child.Name == "Zombie" and espZombieEnabled then
        if child:FindFirstChild("Root") and child:FindFirstChild("Humanoid") then
            -- ðŸ”§ NEW: Verify it's actually a character
            if isValidCharacter(child) then
                createZombieESP(child)
            end
        end
    end
end)

workspace.ChildRemoved:Connect(function(child)
    if child.Name == "Male" then
        if espMaleObjects[child] then
            removeMaleESP(child)
        end
        if espNPCObjects[child] then
            removeNPCESP(child)
        end
    elseif child.Name == "Zombie" and espZombieObjects[child] then
        removeZombieESP(child)
    end
end)

-- Create Rayfield Window
local Window = Rayfield:CreateWindow({
    Name = "Rafso - BRM5 ESP & Fullbright v2.2.1",
    LoadingTitle = "Loading",
    LoadingSubtitle = "by Rafso - FREEZE FIX",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "BRM5_ESP",
        FileName = "ESP_Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvite",
        RememberJoins = true
    },
    KeySystem = false
})

-- Main Tab - ESP
local ESPTab = Window:CreateTab("ESP", 4483362458)
local ESPSection = ESPTab:CreateSection("Player ESP")

local ESPMaleToggle = ESPTab:CreateToggle({
    Name = "Player ESP (Players with Humanoid)",
    CurrentValue = false,
    Flag = "ESPMaleToggle",
    Callback = function(Value)
        espMaleEnabled = Value
        updateMaleESP()
    end,
})

local NPCSection = ESPTab:CreateSection("NPC ESP")

local ESPNPCToggle = ESPTab:CreateToggle({
    Name = "NPC ESP (Male without Humanoid)",
    CurrentValue = false,
    Flag = "ESPNPCToggle",
    Callback = function(Value)
        espNPCEnabled = Value
        updateNPCESP()
    end,
})

local ZombieSection = ESPTab:CreateSection("Zombie ESP")

local ESPZombieToggle = ESPTab:CreateToggle({
    Name = "ESP Zombie",
    CurrentValue = false,
    Flag = "ESPZombieToggle",
    Callback = function(Value)
        espZombieEnabled = Value
        updateZombieESP()
    end,
})

-- FOV Section
local FOVSection = ESPTab:CreateSection("FOV Restriction")

local FOVOnlyToggle = ESPTab:CreateToggle({
    Name = "Show ESP Only in Camera FOV",
    CurrentValue = false,
    Flag = "FOVOnlyToggle",
    Callback = function(Value)
        espFOVOnlyEnabled = Value
    end,
})

local FOVInfo = ESPTab:CreateParagraph({
    Title = "FOV Only Mode - IMPROVED",
    Content = "NOW FIXED:\nâœ“ Proper 90Â° FOV detection\nâœ“ Instant wall detection (no delay)\nâœ“ No ESP through walls\nâœ“ Fast refresh rate (30ms)\nâœ“ Each ESP type keeps its color\nâœ“ NO MORE FREEZES!\n\nESP only shows characters that are:\n1. In front of you (90Â° FOV)\n2. NOT behind walls (real-time check)\n\nNOTE: In FOV mode, each ESP type (Player/NPC/Zombie) keeps its own color!"
})

-- Visibility Section
local VisibilitySection = ESPTab:CreateSection("Visibility Check")

local VisibilityToggle = ESPTab:CreateToggle({
    Name = "Visibility Check",
    CurrentValue = false,
    Flag = "VisibilityToggle",
    Callback = function(Value)
        visibilityCheckEnabled = Value
        if not visibilityCheckEnabled then
            updateMaleESPColors()
            updateNPCESPColors()
            updateZombieESPColors()
        end
    end,
})

local RefreshRateSlider = ESPTab:CreateSlider({
    Name = "Visibility Refresh Rate (ms)",
    Range = {10, 500},
    Increment = 10,
    CurrentValue = 30,
    Flag = "RefreshRateSlider",
    Callback = function(Value)
        VISIBILITY_CHECK_INTERVAL = Value / 1000
    end,
})

local ColorSection = ESPTab:CreateSection("ESP Colors")

local MaleColorDropdown = ESPTab:CreateDropdown({
    Name = "Player Color",
    Options = {"White", "Red", "Green", "Blue", "Yellow", "Cyan", "Orange", "Purple", "Pink"},
    CurrentOption = {"White"},
    MultipleOptions = false,
    Flag = "MaleColorDropdown",
    Callback = function(Option)
        local colors = {
            Pink = Color3.fromRGB(255, 0, 255),
            Red = Color3.fromRGB(255, 0, 0),
            Green = Color3.fromRGB(0, 255, 0),
            Blue = Color3.fromRGB(0, 0, 255),
            Yellow = Color3.fromRGB(255, 255, 0),
            Cyan = Color3.fromRGB(0, 255, 255),
            Orange = Color3.fromRGB(255, 136, 0),
            Purple = Color3.fromRGB(136, 0, 255),
            White = Color3.fromRGB(255, 255, 255)
        }
        
        ESP_MALE_COLOR = colors[Option[1]]
        
        if not visibilityCheckEnabled then
            updateMaleESPColors()
        end
    end,
})

local NPCColorDropdown = ESPTab:CreateDropdown({
    Name = "NPC Color",
    Options = {"Orange", "Pink", "Red", "Green", "Blue", "Yellow", "Cyan", "Purple", "White"},
    CurrentOption = {"Orange"},
    MultipleOptions = false,
    Flag = "NPCColorDropdown",
    Callback = function(Option)
        local colors = {
            Pink = Color3.fromRGB(255, 0, 255),
            Red = Color3.fromRGB(255, 0, 0),
            Green = Color3.fromRGB(0, 255, 0),
            Blue = Color3.fromRGB(0, 0, 255),
            Yellow = Color3.fromRGB(255, 255, 0),
            Cyan = Color3.fromRGB(0, 255, 255),
            Orange = Color3.fromRGB(255, 165, 0),
            Purple = Color3.fromRGB(136, 0, 255),
            White = Color3.fromRGB(255, 255, 255)
        }
        
        ESP_NPC_COLOR = colors[Option[1]]
        
        if not visibilityCheckEnabled then
            updateNPCESPColors()
        end
    end,
})

local ZombieColorDropdown = ESPTab:CreateDropdown({
    Name = "Zombie Color",
    Options = {"Red", "Pink", "Green", "Blue", "Yellow", "Cyan", "Orange", "Purple", "White"},
    CurrentOption = {"Red"},
    MultipleOptions = false,
    Flag = "ZombieColorDropdown",
    Callback = function(Option)
        local colors = {
            Pink = Color3.fromRGB(255, 0, 255),
            Red = Color3.fromRGB(255, 0, 0),
            Green = Color3.fromRGB(0, 255, 0),
            Blue = Color3.fromRGB(0, 0, 255),
            Yellow = Color3.fromRGB(255, 255, 0),
            Cyan = Color3.fromRGB(0, 255, 255),
            Orange = Color3.fromRGB(255, 136, 0),
            Purple = Color3.fromRGB(136, 0, 255),
            White = Color3.fromRGB(255, 255, 255)
        }
        
        ESP_ZOMBIE_COLOR = colors[Option[1]]
        
        if not visibilityCheckEnabled then
            updateZombieESPColors()
        end
    end,
})

local MaleHexInput = ESPTab:CreateInput({
    Name = "Player Custom HEX",
    PlaceholderText = "FF00FF",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        local color = hexToColor3(Text)
        if color then
            ESP_MALE_COLOR = color
            
            if not visibilityCheckEnabled then
                updateMaleESPColors()
            end
        end
    end,
})

local NPCHexInput = ESPTab:CreateInput({
    Name = "NPC Custom HEX",
    PlaceholderText = "FFA500",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        local color = hexToColor3(Text)
        if color then
            ESP_NPC_COLOR = color
            
            if not visibilityCheckEnabled then
                updateNPCESPColors()
            end
        end
    end,
})

local ZombieHexInput = ESPTab:CreateInput({
    Name = "Zombie Custom HEX",
    PlaceholderText = "FF0000",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        local color = hexToColor3(Text)
        if color then
            ESP_ZOMBIE_COLOR = color
            
            if not visibilityCheckEnabled then
                updateZombieESPColors()
            end
        end
    end,
})

-- CONTINUE TO PART 3...
-- PART 3: Fullbright, Keybinds, Settings and Main Loop (FREEZE FIX + DESTROY FIX + CONFIG SAVING)

-- Fullbright Tab
local FullbrightTab = Window:CreateTab("Fullbright", 4483362458)
local FullbrightSection = FullbrightTab:CreateSection("Fullbright")

local FullbrightToggle = FullbrightTab:CreateToggle({
    Name = "Enable Fullbright",
    CurrentValue = false,
    Flag = "FullbrightToggle",
    Callback = function(Value)
        fullbrightEnabled = Value
        if fullbrightEnabled then
            enableFullbright()
        else
            disableFullbright()
        end
    end,
})

-- KEYBINDS TAB
local KeybindsTab = Window:CreateTab("Keybinds", 4483362458)
local KeybindsSection = KeybindsTab:CreateSection("ESP Keybinds")

local MaleESPKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle Player ESP",
    CurrentKeybind = "F1",
    HoldToInteract = false,
    Flag = "MaleESPKeybind",
    Callback = function(Keybind) end,
})

local NPCESPKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle NPC ESP",
    CurrentKeybind = "F2",
    HoldToInteract = false,
    Flag = "NPCESPKeybind",
    Callback = function(Keybind) end,
})

local ZombieESPKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle Zombie ESP",
    CurrentKeybind = "F3",
    HoldToInteract = false,
    Flag = "ZombieESPKeybind",
    Callback = function(Keybind) end,
})

local FOVKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle FOV Only Mode",
    CurrentKeybind = "F5",
    HoldToInteract = false,
    Flag = "FOVKeybind",
    Callback = function(Keybind) end,
})

local VisibilityKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle Visibility Check",
    CurrentKeybind = "F6",
    HoldToInteract = false,
    Flag = "VisibilityKeybind",
    Callback = function(Keybind) end,
})

local FullbrightKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle Fullbright",
    CurrentKeybind = "F4",
    HoldToInteract = false,
    Flag = "FullbrightKeybind",
    Callback = function(Keybind) end,
})

local GUIKeybind = KeybindsTab:CreateKeybind({
    Name = "Toggle GUI Visibility",
    CurrentKeybind = "K",
    HoldToInteract = false,
    Flag = "GUIKeybind",
    Callback = function(Keybind) end,
})

local KeybindsInfo = KeybindsTab:CreateParagraph({
    Title = "Keybinds",
    Content = "Click on a keybind button and press any key to set it.\n\nDefault Keybinds:\nF1 = Player ESP\nF2 = NPC ESP\nF3 = Zombie ESP\nF4 = Fullbright\nF5 = FOV Only\nF6 = Visibility Check\nK = Toggle GUI\n\nKeybinds work even when GUI is hidden!"
})

-- Settings Tab
local SettingsTab = Window:CreateTab("Settings", 4483362458)

-- ðŸ†• CONFIG SAVING SECTION
local ConfigSection = SettingsTab:CreateSection("Configuration")

local AutoLoadToggle = SettingsTab:CreateToggle({
    Name = "ðŸ”„ Auto-Load Config on Startup",
    CurrentValue = true,
    Flag = "AutoLoadConfig",
    Callback = function(Value)
        -- This setting itself is saved, so it persists
        if Value then
            Rayfield:Notify({
                Title = "Auto-Load Enabled!",
                Content = "Your config will load automatically on startup.",
                Duration = 3,
                Image = 4483362458,
            })
        else
            Rayfield:Notify({
                Title = "Auto-Load Disabled!",
                Content = "You'll need to manually load your config.",
                Duration = 3,
                Image = 4483362458,
            })
        end
    end,
})

local SaveConfigButton = SettingsTab:CreateButton({
    Name = "ðŸ’¾ Save Current Configuration",
    Callback = function()
        Rayfield:Notify({
            Title = "Configuration Saved!",
            Content = "All settings, colors, and keybinds saved!\nAuto-Load: " .. (Rayfield.Flags["AutoLoadConfig"].CurrentValue and "ON" or "OFF"),
            Duration = 4,
            Image = 4483362458,
        })
        
        -- Rayfield automatically saves when you close the game
        -- This button just confirms the current state is saved
        print("Configuration saved!")
    end,
})

local LoadConfigButton = SettingsTab:CreateButton({
    Name = "ðŸ“‚ Load Saved Configuration",
    Callback = function()
        -- Manually trigger ESP updates based on loaded flags
        if Rayfield.Flags["ESPMaleToggle"] then
            espMaleEnabled = Rayfield.Flags["ESPMaleToggle"].CurrentValue
            updateMaleESP()
        end
        
        if Rayfield.Flags["ESPNPCToggle"] then
            espNPCEnabled = Rayfield.Flags["ESPNPCToggle"].CurrentValue
            updateNPCESP()
        end
        
        if Rayfield.Flags["ESPZombieToggle"] then
            espZombieEnabled = Rayfield.Flags["ESPZombieToggle"].CurrentValue
            updateZombieESP()
        end
        
        if Rayfield.Flags["FOVOnlyToggle"] then
            espFOVOnlyEnabled = Rayfield.Flags["FOVOnlyToggle"].CurrentValue
        end
        
        if Rayfield.Flags["VisibilityToggle"] then
            visibilityCheckEnabled = Rayfield.Flags["VisibilityToggle"].CurrentValue
        end
        
        if Rayfield.Flags["FullbrightToggle"] then
            fullbrightEnabled = Rayfield.Flags["FullbrightToggle"].CurrentValue
            if fullbrightEnabled then
                enableFullbright()
            else
                disableFullbright()
            end
        end
        
        Rayfield:Notify({
            Title = "Configuration Loaded!",
            Content = "All saved settings restored!",
            Duration = 3,
            Image = 4483362458,
        })
        
        print("Configuration loaded!")
    end,
})

local ResetConfigButton = SettingsTab:CreateButton({
    Name = "ðŸ”„ Reset to Default Settings",
    Callback = function()
        -- Reset all toggles to default (false)
        ESPMaleToggle:Set(false)
        ESPNPCToggle:Set(false)
        ESPZombieToggle:Set(false)
        FOVOnlyToggle:Set(false)
        VisibilityToggle:Set(false)
        FullbrightToggle:Set(false)
        
        -- Reset Auto-Load to default (true)
        AutoLoadToggle:Set(true)
        
        -- Reset colors to default
        ESP_MALE_COLOR = Color3.fromRGB(255, 255, 255)
        ESP_NPC_COLOR = Color3.fromRGB(255, 165, 0)
        ESP_ZOMBIE_COLOR = Color3.fromRGB(255, 0, 0)
        
        MaleColorDropdown:Set({"White"})
        NPCColorDropdown:Set({"Orange"})
        ZombieColorDropdown:Set({"Red"})
        
        -- Reset refresh rate
        RefreshRateSlider:Set(30)
        VISIBILITY_CHECK_INTERVAL = 0.03
        
        -- Update all ESP
        updateMaleESPColors()
        updateNPCESPColors()
        updateZombieESPColors()
        
        Rayfield:Notify({
            Title = "Settings Reset!",
            Content = "All settings restored to default values.\nAuto-Load: ON (default)",
            Duration = 3,
            Image = 4483362458,
        })
        
        print("Settings reset to default!")
    end,
})

local ConfigInfo = SettingsTab:CreateParagraph({
    Title = "Auto-Save & Auto-Load Info",
    Content = "âœ… Rayfield automatically saves your config when you close the game!\n\nðŸ”„ Auto-Load Toggle:\nâ€¢ ON: Config loads automatically on startup\nâ€¢ OFF: You must manually load config\n\nðŸ’¾ Save Button: Confirms current settings\nðŸ“‚ Load Button: Restores last saved config\nðŸ”„ Reset Button: Restores default settings\n\nSaved Settings Include:\nâ€¢ All ESP toggles\nâ€¢ ESP colors (including HEX)\nâ€¢ FOV & Visibility modes\nâ€¢ Fullbright state\nâ€¢ Keybinds\nâ€¢ Refresh rate\nâ€¢ Auto-Load preference"
})

-- DESTROY SECTION
local DestroySection = SettingsTab:CreateSection("Destroy")

-- ðŸ”¥ DECLARE mainLoopConnection and keybindConnection as variables first
local mainLoopConnection
local keybindConnection

local DestroyButton = SettingsTab:CreateButton({
    Name = "Destroy GUI",
    Callback = function()
        print("Destroying ESP System...")
        
        -- ðŸ”¥ FIX: Force disable ALL features BEFORE disconnecting
        espMaleEnabled = false
        espNPCEnabled = false
        espZombieEnabled = false
        visibilityCheckEnabled = false
        fullbrightEnabled = false
        espFOVOnlyEnabled = false
        
        -- Update ESP to remove all visuals
        updateMaleESP()
        updateNPCESP()
        updateZombieESP()
        
        -- ðŸ”¥ FIX: Disconnect keybinds FIRST (prevents re-enabling after destruction)
        if keybindConnection then
            keybindConnection:Disconnect()
            keybindConnection = nil
            print("Keybind connection disconnected")
        end
        
        -- Disconnect all other connections
        if fullbrightLoop then
            fullbrightLoop:Disconnect()
            fullbrightLoop = nil
            print("Fullbright loop disconnected")
        end
        
        if mainLoopConnection then
            mainLoopConnection:Disconnect()
            mainLoopConnection = nil
            print("Main loop disconnected")
        end
        
        -- Disable fullbright
        disableFullbright()
        
        -- Destroy all Male ESP
        for character, espObject in pairs(espMaleObjects) do
            pcall(function()
                if espObject and espObject.Parent then
                    espObject:Destroy()
                end
            end)
        end
        
        -- Destroy all NPC ESP
        for character, espObject in pairs(espNPCObjects) do
            pcall(function()
                if espObject and espObject.Parent then
                    espObject:Destroy()
                end
            end)
        end
        
        -- Destroy all Zombie ESP
        for character, espObject in pairs(espZombieObjects) do
            pcall(function()
                if espObject and espObject.Parent then
                    espObject:Destroy()
                end
            end)
        end
        
        -- Clear all tables
        espMaleObjects = {}
        espNPCObjects = {}
        espZombieObjects = {}
        partVisibility = {}
        
        -- Deep cleanup of all ESP objects in workspace
        for _, model in pairs(workspace:GetDescendants()) do
            pcall(function()
                if model:IsA("Highlight") and model.Name == "ESPHighlight" then
                    model:Destroy()
                end
                if model:IsA("Folder") and model.Name == "ESPFolder" then
                    model:Destroy()
                end
                if model:IsA("BoxHandleAdornment") and (model.Name == "ESPBox" or model.Name == "ESPOutline") then
                    model:Destroy()
                end
            end)
        end
        
        print("All ESP removed and connections disconnected!")
        
        Rayfield:Notify({
            Title = "ESP System Destroyed",
            Content = "All traces cleaned!\nKeybinds FULLY disabled!",
            Duration = 3,
            Image = 4483362458,
        })
        
        task.wait(1)
        Rayfield:Destroy()
    end,
})

-- Credits Tab
local CreditsTab = Window:CreateTab("Credits", 4483362458)
local CreditsSection = CreditsTab:CreateSection("by Rafso")

local VerParagraph = CreditsTab:CreateParagraph({
    Title = "Version 2.2.3 - CONFIG SAVING",
    Content = "ðŸ†• Configuration Saving!\nðŸ’¾ Auto-saves on game close\nðŸ”„ Auto-Load toggle option\nðŸ“‚ Manual save/load buttons\nðŸ”„ Reset to defaults\n\nPrevious Updates:\nâ€¢ Enhanced FOV (12 body parts)\nâ€¢ Destroy GUI fix\nâ€¢ Arms & Legs detection\nâ€¢ Memory optimization\nâ€¢ No freezes"
})

-- ðŸ”¥ FREEZE FIX: OPTIMIZED Main Loop with Memory Management
local lastVisibilityUpdate = 0
local lastFullUpdate = 0
local lastCleanup = 0

mainLoopConnection = RunService.RenderStepped:Connect(function()
    if not (espMaleEnabled or espNPCEnabled or espZombieEnabled) then return end
    
    local currentTime = tick()
    
    -- ðŸ”¥ FREEZE FIX: Periodic cleanup to prevent memory buildup
    if (currentTime - lastCleanup) >= 5 then
        cleanupPartVisibility()
        lastCleanup = currentTime
    end
    
    -- INSTANT visibility updates when FOV mode is active
    if espFOVOnlyEnabled then
        updateMaleESPColors()
        updateNPCESPColors()
        updateZombieESPColors()
    elseif visibilityCheckEnabled and (currentTime - lastVisibilityUpdate) >= VISIBILITY_CHECK_INTERVAL then
        updateMaleESPColors()
        updateNPCESPColors()
        updateZombieESPColors()
        lastVisibilityUpdate = currentTime
    elseif not visibilityCheckEnabled and (currentTime - lastVisibilityUpdate) >= 0.5 then
        updateMaleESPColors()
        updateNPCESPColors()
        updateZombieESPColors()
        lastVisibilityUpdate = currentTime
    end
    
    -- Full check every 1.5 seconds
    if (currentTime - lastFullUpdate) >= 1.5 then
        -- ðŸ”¥ FREEZE FIX: Clean dead characters AND partVisibility
        for character, espObject in pairs(espMaleObjects) do
            if not character or not character.Parent or not espObject or not espObject.Parent then
                pcall(function()
                    if espObject then espObject:Destroy() end
                end)
                espMaleObjects[character] = nil
                partVisibility[character] = nil
            end
        end
        
        for character, espObject in pairs(espNPCObjects) do
            if not character or not character.Parent or not espObject or not espObject.Parent then
                pcall(function()
                    if espObject then espObject:Destroy() end
                end)
                espNPCObjects[character] = nil
                partVisibility[character] = nil
            end
        end
        
        for character, espObject in pairs(espZombieObjects) do
            if not character or not character.Parent or not espObject or not espObject.Parent then
                pcall(function()
                    if espObject then espObject:Destroy() end
                end)
                espZombieObjects[character] = nil
                partVisibility[character] = nil
            end
        end
        
        -- Add new characters
        if espMaleEnabled then
            for _, model in pairs(workspace:GetChildren()) do
                if model.Name == "Male" and model:FindFirstChild("Root") and model:FindFirstChild("Humanoid") then
                    if isValidCharacter(model) and not espMaleObjects[model] then
                        createMaleESP(model)
                    end
                end
            end
        end
        
        if espNPCEnabled then
            for _, model in pairs(workspace:GetChildren()) do
                if model.Name == "Male" and model:FindFirstChild("Root") and not model:FindFirstChild("Humanoid") then
                    if isValidCharacter(model) and not espNPCObjects[model] then
                        createNPCESP(model)
                    end
                end
            end
        end
        
        if espZombieEnabled then
            for _, model in pairs(workspace:GetChildren()) do
                if model.Name == "Zombie" and model:FindFirstChild("Root") and model:FindFirstChild("Humanoid") then
                    if isValidCharacter(model) and not espZombieObjects[model] then
                        createZombieESP(model)
                    end
                end
            end
        end
        
        lastFullUpdate = currentTime
    end
    
    if fullbrightEnabled and not fullbrightLoop then
        enableFullbright()
    end
end)

-- ðŸ†• KEYBIND DETECTION SYSTEM (NOW DEFINED AFTER MAIN LOOP)
keybindConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    -- ðŸ”¥ FIX: Check if GUI was destroyed (mainLoopConnection disconnected)
    if mainLoopConnection and not mainLoopConnection.Connected then
        return -- GUI destroyed, ignore keybinds
    end
    
    if input.KeyCode.Name == Rayfield.Flags["MaleESPKeybind"].CurrentKeybind or 
       input.KeyCode.Name == "F1" then
        espMaleEnabled = not espMaleEnabled
        ESPMaleToggle:Set(espMaleEnabled)
        updateMaleESP()
    end
    
    if input.KeyCode.Name == Rayfield.Flags["NPCESPKeybind"].CurrentKeybind or 
       input.KeyCode.Name == "F2" then
        espNPCEnabled = not espNPCEnabled
        ESPNPCToggle:Set(espNPCEnabled)
        updateNPCESP()
    end
    
    if input.KeyCode.Name == Rayfield.Flags["ZombieESPKeybind"].CurrentKeybind or 
       input.KeyCode.Name == "F3" then
        espZombieEnabled = not espZombieEnabled
        ESPZombieToggle:Set(espZombieEnabled)
        updateZombieESP()
    end
    
    if input.KeyCode.Name == Rayfield.Flags["FullbrightKeybind"].CurrentKeybind or 
       input.KeyCode.Name == "F4" then
        fullbrightEnabled = not fullbrightEnabled
        FullbrightToggle:Set(fullbrightEnabled)
        
        if fullbrightEnabled then
            enableFullbright()
        else
            disableFullbright()
        end
    end
    
    if input.KeyCode.Name == Rayfield.Flags["FOVKeybind"].CurrentKeybind or 
       input.KeyCode.Name == "F5" then
        espFOVOnlyEnabled = not espFOVOnlyEnabled
        FOVOnlyToggle:Set(espFOVOnlyEnabled)
    end
    
    if input.KeyCode.Name == Rayfield.Flags["VisibilityKeybind"].CurrentKeybind or 
       input.KeyCode.Name == "F6" then
        visibilityCheckEnabled = not visibilityCheckEnabled
        VisibilityToggle:Set(visibilityCheckEnabled)
        
        if not visibilityCheckEnabled then
            updateMaleESPColors()
            updateNPCESPColors()
            updateZombieESPColors()
        end
    end
    
    if input.KeyCode == Enum.KeyCode.K then
        Rayfield:Toggle()
    end
end)

-- ðŸ”¥ FREEZE FIX: Force gentle garbage collection every 20 seconds
task.spawn(function()
    while task.wait(20) do
        -- ðŸ”¥ FIX: Stop garbage collection if GUI destroyed
        if not mainLoopConnection or not mainLoopConnection.Connected then
            break
        end
        collectgarbage("collect")
        task.wait(0.1)
    end
end)

-- ðŸ†• AUTO-LOAD CONFIG ON STARTUP (if enabled)
task.spawn(function()
    task.wait(1) -- Wait for GUI to fully initialize
    
    -- Check if Auto-Load is enabled
    local autoLoadEnabled = true -- Default to true
    if Rayfield.Flags["AutoLoadConfig"] then
        autoLoadEnabled = Rayfield.Flags["AutoLoadConfig"].CurrentValue
    end
    
    if not autoLoadEnabled then
        print("Auto-Load disabled - config not loaded")
        Rayfield:Notify({
            Title = "Auto-Load Disabled",
            Content = "Use 'Load Saved Configuration' button to manually load your settings.",
            Duration = 4,
            Image = 4483362458,
        })
        return
    end
    
    -- Auto-load is enabled, load saved config
    local configLoaded = false
    
    if Rayfield.Flags["ESPMaleToggle"] and Rayfield.Flags["ESPMaleToggle"].CurrentValue then
        espMaleEnabled = true
        updateMaleESP()
        configLoaded = true
    end
    
    if Rayfield.Flags["ESPNPCToggle"] and Rayfield.Flags["ESPNPCToggle"].CurrentValue then
        espNPCEnabled = true
        updateNPCESP()
        configLoaded = true
    end
    
    if Rayfield.Flags["ESPZombieToggle"] and Rayfield.Flags["ESPZombieToggle"].CurrentValue then
        espZombieEnabled = true
        updateZombieESP()
        configLoaded = true
    end
    
    if Rayfield.Flags["FullbrightToggle"] and Rayfield.Flags["FullbrightToggle"].CurrentValue then
        fullbrightEnabled = true
        enableFullbright()
        configLoaded = true
    end
    
    if configLoaded then
        print("Configuration auto-loaded!")
        Rayfield:Notify({
            Title = "Config Auto-Loaded!",
            Content = "Your saved settings have been restored.",
            Duration = 3,
            Image = 4483362458,
        })
    else
        print("No saved configuration found")
    end
end)

-- Loading notification
Rayfield:Notify({
    Title = "ESP System v2.2.3 Loaded!",
    Content = "ðŸ†• Config saving with Auto-Load toggle!\nðŸ’¾ Auto-saves on close",
    Duration = 5,
    Image = 4483362458,
})
